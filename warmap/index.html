<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ö–∞—Ä—Ç–∞ –∑ —Ç–æ—á–∫–∞–º–∏</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
        #map{width:100%;height:100vh}
        .info-panel{position:absolute;top:10px;right:10px;background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.2);z-index:1000;max-width:250px;max-height:60vh;overflow-y:auto}
        .info-panel h3{margin-bottom:10px;font-size:16px}
        .popup-content{max-width:300px;position:relative;padding:10px;padding-bottom:45px}
        .popup-content h4{margin:0 0 8px 0;color:#333}
        .popup-content p{margin:8px 0;font-size:14px;color:#666;word-wrap:break-word}
        .popup-images{display:block;margin:8px 0;width:100%}
        .popup-images a{display:block;margin-bottom:8px;width:100%}
        .popup-images img{width:100%;max-height:250px;display:block;object-fit:contain;border-radius:0;border:none;margin-bottom:8px}
        .share-button{position:sticky;bottom:8px;right:8px;float:right;margin-top:8px;width:32px;height:32px;border-radius:50%;background:#007bff;color:#fff;border:none;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;opacity:.9}
        .leaflet-popup-content{margin:0;width:300px !important;overflow:hidden}
        .leaflet-popup-content-wrapper{padding:0;overflow:hidden}
        .custom-popup .leaflet-popup-content-wrapper{border-radius:8px}
        .popup-content p a{color:#007bff;text-decoration:none}
        .popup-content p a:hover{text-decoration:underline}
        @media (max-width:600px){
            .info-panel{position:static;margin:10px;width:calc(100% - 20px);max-height:30vh}
            #map{height:calc(100vh - 120px)}
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <h3>üìç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <p>–í—Å—å–æ–≥–æ —Ç–æ—á–æ–∫: <strong id="totalPoints">0</strong></p>
        <p id="progress" style="font-size:13px;color:#555;margin-top:6px"></p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
    // --- –ë–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏ –∏ –∫–∞—Ä—Ç–∞ ---
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    });
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });

    const map = L.map('map', { center: [50.4501, 30.5234], zoom: 6, layers: [osm] });
    L.control.layers({ "–ö–∞—Ä—Ç–∞": osm, "–°–ø—É—Ç–Ω–∏–∫": esriSat }, {}, { collapsed: false, position: 'topleft' }).addTo(map);

    // MarkerClusterGroup —Å chunkedLoading –∏ –±–æ–ª–µ–µ ¬´—Å–≤–æ–±–æ–¥–Ω–æ–π¬ª –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–µ–π
    const markers = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 30,          // –º–µ–Ω—å—à–µ = –º–∞—Ä–∫–µ—Ä—ã —Ä–µ–∂–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è
    });

    markers.addTo(map);

    // --- –£—Ç–∏–ª–∏—Ç—ã ---
    function escapeHtml(str) {
        if (str === undefined || str === null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function linkify(text) {
        if (!text) return '';
        let t = escapeHtml(text);
        t = t.replace(/(tg:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        t = t.replace(/((https?:\/\/|www\.)[^\s<]+)/g, function(m) {
            let url = m;
            if (!/^https?:\/\//i.test(url)) url = 'http://' + url;
            return `<a href="${url}" target="_blank" rel="noopener noreferrer">${m}</a>`;
        });
        return t;
    }

    // --- Share –∫–Ω–æ–ø–∫–∞ ---
    function handleShareButtonClick(e) {
        const tgt = e.target;
        if (!tgt.classList) return;
        if (!tgt.classList.contains('share-button')) return;
        const lat = tgt.getAttribute('data-lat');
        const lng = tgt.getAttribute('data-lng');
        const url = `${window.location.origin}${window.location.pathname}#lat=${lat}&lng=${lng}`;
        navigator.clipboard.writeText(url).then(() => { alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!'); })
            .catch(err => console.error('–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è: ', err));
    }

    map.on('popupopen', function(e) {
        const marker = e.popup._source;
        const coords = marker.getLatLng();
        history.replaceState(null, null, `#lat=${coords.lat}&lng=${coords.lng}`);
        const popupEl = e.popup.getElement();
        if (popupEl) {
            popupEl.removeEventListener('click', handleShareButtonClick);
            popupEl.addEventListener('click', handleShareButtonClick);
        }
    });

    function checkLocationHash() {
        const hash = window.location.hash;
        if (hash) {
            const params = new URLSearchParams(hash.slice(1));
            const lat = parseFloat(params.get('lat'));
            const lng = parseFloat(params.get('lng'));
            if (!isNaN(lat) && !isNaN(lng)) {
                map.setView([lat, lng], 16);
                setTimeout(() => {
                    markers.eachLayer(layer => {
                        const ll = layer.getLatLng();
                        if (ll && ll.lat === lat && ll.lng === lng) layer.openPopup();
                    });
                }, 400);
            }
        }
    }

    async function addInBatches(markerArray, batchSize = 500) {
        const total = markerArray.length;
        let processed = 0;
        document.getElementById('progress').textContent = `–î–æ–¥–∞—î–º–æ: 0 / ${total}`;
        for (let i = 0; i < markerArray.length; i += batchSize) {
            const batch = markerArray.slice(i, i + batchSize);
            markers.addLayers(batch);
            processed += batch.length;
            document.getElementById('progress').textContent = `–î–æ–¥–∞—î–º–æ: ${processed} / ${total}`;
            await new Promise(r => setTimeout(r, 25));
        }
        document.getElementById('progress').textContent = '';
    }

    async function loadPoints() {
        try {
            const url = 'https://blamp26.github.io/escalationdp/warmap/points.json';
            const fetchUrl = url + '?_=' + Date.now();
            console.log('Fetching points.json ->', fetchUrl);

            const response = await fetch(fetchUrl, { cache: 'no-store' });
            console.log('Response status:', response.status);
            console.log('Response headers:', {
                'cache-control': response.headers.get('cache-control'),
                'etag': response.headers.get('etag'),
                'age': response.headers.get('age'),
                'x-cache': response.headers.get('x-cache')
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            console.log('Loaded data:', data);
            if (!data.points || !Array.isArray(data.points)) throw new Error('Invalid data structure: points array is missing');

            document.getElementById('totalPoints').textContent = data.points.length;
            markers.clearLayers();

            const markerArray = data.points.map(point => {
                const lat = parseFloat(point.lat);
                const lng = parseFloat(point.lng);
                if (isNaN(lat) || isNaN(lng)) return null;

                const marker = L.marker([lat, lng]);
                const descHtml = point.description ? `<p>${linkify(point.description)}</p>` : '';
                const imgsHtml = (point.images && Array.isArray(point.images) && point.images.length)
                    ? `<div class="popup-images">${point.images.map(url => `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer"><img src="${escapeHtml(url)}" alt="${escapeHtml(point.name || '')}"></a>`).join('')}</div>`
                    : '';

                const popupContent = `
                    <div class="popup-content">
                        <h4>${escapeHtml(point.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏')}</h4>
                        ${point.category ? `<p><strong>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</strong> ${escapeHtml(point.category)}</p>` : ''}
                        ${descHtml}
                        ${imgsHtml}
                        <div style="clear:both;">
                            <button class="share-button" data-lat="${lat}" data-lng="${lng}" data-name="${encodeURIComponent(point.name || '')}">üîó</button>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    minWidth: 300,
                    className: 'custom-popup',
                    autoPanPadding: [50, 50]
                });
                return marker;
            }).filter(m => m !== null);

            try {
                markers.addLayers(markerArray);
            } catch (err) {
                console.warn('addLayers failed, falling back to batched addition:', err);
                await addInBatches(markerArray, 200);
            }

            if (markers.getLayers().length > 0) {
                const bounds = markers.getBounds();
                if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50] });
            }

            checkLocationHash();
            console.log('Markers added:', markers.getLayers().length);
        } catch (error) {
            console.error('–î–µ—Ç–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ—á–æ–∫:', error);
        }
    }

    loadPoints();
    </script>
</body>
</html>
